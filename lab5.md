# lab5做了什么

1. 基于磁盘的硬件构成实现通过`I/O`接口**驱动**来与磁盘外设进行交互(主要是**屏蔽丑陋的硬件,提供统一的读写接口**)
2. 基于`I/O`交互以及磁盘的空间搭建文件系统结构(本质上就是用**数据结构**管理磁盘的空间)
3. 基于文件系统来向用户提供操作的接口(以**系统调用**的形式)

# 具体实现

## 外部存储设备驱动

这部分很依赖于底层硬件的构成标准

### 磁盘寻址的原理

~~这部分我们OS实现不用考虑权当复习理论课了~~

#### 地址表达

一个扇区大小(**有效数据大小为一块即512字节**)为最小的数据交换单元

* 物理磁盘使用柱面,磁道,扇区构成**物理地址**来定位一个块, 即

  **某一磁盘寻址依赖于** : (括号中均为常量)

  1. 柱面号`C_index`(一共有`C_num`个柱面)
  2. 磁头号`H_index`(一共有`H_num`层磁头)
  3. 扇区号`S_index`(一个磁道有`S_num`个扇区)

  ![](OS-lab5\disk.png)

* 而**逻辑地址**则将所有扇区抽象成连续的块结构**通过偏移获取**

  **抽象规则为 : `offset = C_index * H_num + H_index * S_num + S_index`**

1. OS发出的请求 : 盘号`diskno` + 偏移`offset`
2. 由盘号定位到某一磁盘接受之后寻址 : 
   * **由逻辑地址向物理地址转换 : **
     1. `C_index = offset / (H_num * S_num)`
     2. `H_index = (offset % (H_num * S_num)) / S_num`
     3. `S_index = (offset % (H_num * S_num)) % S_num`

### OS与外设交互的机制

**通过读写设备上的寄存器来进行数据通信** :

1. 外设寄存器也称为 I/O 端口，我们使用 I/O 端口来访问 I/O 设备
2. 外设寄存器通常包括控制寄存器、状态寄存器和数据寄存器
3. **这些硬件 I/O 寄存器被映射到指定的内存空间**

**故我们读写某一固定的物理内存(固定值取决于外设种类对应的规定)就相当于读写外设的寄存器这样我们就能控制其行为**

### IDE磁盘在硬件层次的规定

* 其映射到的物理内存区域是`[0x13000000, 0x13004200)`

* 在CPU访问时使用的只能是虚拟地址,所以我们要把这块区域**映射到内核空间的`kseg1`中(因为这片空间是内核中的,映射固定(加偏移即可),并且数据不会被缓存**,`kesg`的起始地址为`0xA0000000 `,**所以磁盘外设寄存器对应的虚拟地址为`[0xB3000000, 0xB3004200)`**

* 磁盘各个外设寄存器的意义 : 

  ![](OS-lab5\IDE-regs.png)

* 所以我们的对磁盘的`I/O`操作就如下图

* 

